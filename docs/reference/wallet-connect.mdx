# Adding Support for WalletConnect 2.0 to FCL

To improve developer experience and streamline Flow dApp integration with WalletConnect, FCL `^1.3.0` includes support for compatible wallets that use the WalletConnect 2.0 protocol. DApps can opt-in through use of the [**fcl-wc**](https://www.npmjs.com/package/@onflow/fcl-wc) package and **FCL Plugin Registry**.

## How does it work?

- The **`fc-wc`** package is used to initialize a **WalletConnect 2.0** **`SignClient`**, and build a **`ServicePlugin`** based on dApp specified options.
- The **FCL Plugin Registry** allows for dApps to add new services, and the methods and execution strategies needed to interact with them.
- **ServicePlugins** of type **`discovery-service`** are used to add opt-in wallets and other services to **FCL Wallet Discovery** (UI/API).

## Adding Support for WalletConnect to an FCL dApp

When using FCL Discovery for authentication, dApps are able to support most FCL-compatible wallets and their users on Flow without any custom integrations or changes needed to the dApp code. These instructions explain how dApps can also add support for FCL compatible wallets that use the WalletConnect 2.0 protocol.

### Requirements

- `fcl` version >= `1.3.0`
- `fcl-wc` version >= `1.0.0`

### Implementation path

|     |    |    |
| :-: | :- | :- |
| **1** | Add required packages | Install and import minimum `fcl` and `fcl-wc` [versions](#requirements)|
| **2** | Obtain a WalletConnect `projectID` | Visit [WalletConnect Cloud Registry](https://cloud.walletconnect.com/) and register for public relay server access and an application `projectId` |
| **3** | Initialize WalletConnect `SignClient` and `FclWcServicePlugin` | Initialize WalletConnect `SignClient` and `FclWcServicePlugin` with [configuration options](#fclwcserviceplugin) |
| **4** | Add FclWcServicePlugin to FCL Plugin Registry | Inject `FclWcServicePlugin` via `fcl.pluginRegistry.add(FclWcServicePlugin)` |

### 1. Add required packages

Install the `fcl` and `fcl-wc` packages:

```bash
npm install @onflow/fcl@ @onflow/fcl-wc
```

#### Note

⚠️ FCL needs to be configured with a specified network. 
`fcl.config({"flow.network": "mainnet"})`

See [FCL Configuration](https://docs.onflow.org/fcl/reference/fcl-configuration/) for more information.

### 2. Obtain a WalletConnect projectID

Visit [WalletConnect Cloud Registry](https://cloud.walletconnect.com/) and register for public relay server access and an application **`projectId`**.

### 3. Initialize WalletConnect `SignClient` and `FclWcServicePlugin`

In addition to the WalletConnect `SignClient`, the `init` method of `fcl-wc` returns a `ServicePlugin` object. This object can be injected into the FCL Plugin Registry to add FCL support for new service methods, like (WC/RPC) for WalletConnect and corresponding execution strategies.
A `ServicePlugin` may also include additional opt-in services to offer your users through FCL Wallet Discovery.

### Plugin Configuration

Initialize WalletConnect `SignClient` and `FclWcServicePlugin` with the following configuration options:

- projectId: string **required**
- metadata: {}
- includeBaseWC: boolean? (default false)
- sessionRequestHook: () => {} (default null)
- wallets: [] A list of WalletConnect services to include in Discovery
  projectId,
  metadata,
  includeBaseWC = false,
  wcRequestHook = null,
  pairingModalOverride = null,
  wallets = [],

#### Arguments

| Name       | Type    | Default | Description                                                                    |
| ---------- | ------- | ------- | ------------------------------------------------------------------------------ |
| `projectId` | boolean **(required)** | null   | If the latest block should be sealed or not. See [block states](./api.md#interaction). |
| `metadata` | object | { }  | If the latest block should be sealed or not. See [block states](./api.md#interaction). |
| `includeBaseWC` | boolean | false   | If the latest block should be sealed or not. See [block states](./api.md#interaction). |
| `wcRequestHook` | function | null  | If the latest block should be sealed or not. See [block states](./api.md#interaction). |
| `pairingModalOverride` | function | null  | If the latest block should be sealed or not. See [block states](./api.md#interaction). |
| `wallets` | array | [ ] | If the latest block should be sealed or not. See [block states](./api.md#interaction). |


#### Returns

|  Name  |  Type  |  Description  |
| ----- | ------- | ---------- |
| [FclWcServicePlugin](#fclwcserviceplugin) | `ServicePlugin` | A ServicePlugin of type `discovery-service` may also include optional services to offer through FCL Wallet Discovery. |
| [client](#) | `SignClient` | An initialized WalletConnect `SignClient` |

### 4. Add FclWcServicePlugin to FCL Plugin Registry

When using FCL for authentication, DApps are able to support most FCL-compatible wallets on Flow and their users without any custom integrations or changes needed to the dapp code.
These instructions explain how DApps can also add support for FCL compatible wallets that use WalletConnect protocol.
		
Once a valid wcServicePlugin is registered, FCL adds WalletConnect wallets to Discovery. To connect a Flow supported wallet using WalletConnect, users of your dApp will go through the authentication process and have the option to select any FCL compatible WalletConnect provider.

FCL will handle client connections and pairing during FCL `authn`, and initiate WalletConnect signing requests as part of `authz`/`mutate` or [`user signing`](https://github.com/onflow/fcl-js/blob/master/docs/reference/user-signatures.mdx).

#### Usage

```js
import * as fcl from "@onflow/fcl"
import { init } from "fcl-wc"

const { FclWcServicePlugin, client } = await init({
  projectId: WC_PROJECT_ID, // required
  metadata: WC_APP_METADATA, // optional
  includeBaseWC: false, // optional, default: false
  wallets: [], // optional, default: []
  wcRequestHook: (wcRequestData) => { // optional,default: null
    handlePendingRequest(data)
  },
  pairingModalOverride: (uri, rejectPairingRequest) => { // optional,default: null
    handlePendingPairingRequest(data)
  }
})

fcl.pluginRegistry.add(FclWcServicePlugin)
```
---

### FclWcServicePlugin

In addition to the WalletConnect `SignClient`, the `init` method of `fcl-wc` returns a `ServicePlugin` object. This object can be injected into the FCL Plugin Registry to add FCL support for new service methods, like (WC/RPC) for WalletConnect and corresponding execution strategies.
A `ServicePlugin` may also include optional services to offer through FCL Wallet Discovery.

A subtype of the [ServicePlugin](#serviceplugin-spec).

```js
{
  name: "fcl-plugin-service-walletconnect",
  f_type: "ServicePlugin",
  type: "discovery-service",
  services: await makeWcServices(opts),
  serviceStrategy: {method: "WC/RPC", exec: makeExec(client, opts)},
}
```

### ServicePlugin Spec

| Key         | Value Type | Description                   |
| ----------- | ---------- | ----------------------------- |
| `name`        | string     | The id of the block.          |
| `f_type`  | string     | The id of the parent block.   |
| `type`    | number     | The height of the block.      |
| `services` | object     | Contains time related fields. |
| `serviceStrategy` | object     | Contains time related fields. |

  - Service
    - method: string (WC/RPC)
      - The method specifies the strategy to use to interact with a service. A service with the service.method property set to "WC/RPC" tells FCL to use the corresponding service strategy if it is supported by the dApp.
    - uid: string (universal link url)
      - The uid is a unique identifier for the service. It is used to identify the service in the FCL Plugin Registry.
  - Strategy
    - Define and list Base supported strategies
    - Service Strategy Spec
      - method: string
        - The method specifies the strategy to use to interact with a service. A service with the service.method property set to "WC/RPC" tells FCL to use the corresponding service strategy if it is supported by the dApp.
      - exec: () => {}
        - The function that executes calls to the service
        - Returns a promise that returns a PollingResponse

```js
const FclWcServicePlugin = ({
  name: "fcl-plugin-service-walletconnect",
  f_type: "ServicePlugin",
  type: "discovery-service",
  services: await makeWcServices(opts),
  serviceStrategy: {method: "WC/RPC", exec: makeExec(client, opts)},
})
```

---

## Wallet Discovery

Knowing all the wallets available to users on a blockchain can be challenging. FCL's Discovery mechanism relieves much of the burden of integrating with Flow compatible wallets and let's developers focus on building their dApp and providing as many options as possible to their users.

There are two ways an app can use Discovery:

1. The UI version which can be configured for display via iFrame, Popup, or Tab.

2. The API version which allows you to access authentication services directly in your code via fcl.discovery.authn method which we'll describe below.](<https://github.com/onflow/fcl-js/blob/master/docs/reference/discovery.mdx>)

![Wallet Discovery UI](../images/discovery.png)

### How to add your flow enabled wc wallet to Discovery (UI/API)

1. Add to Discovery services.json PR
2. Add to WC Wallet Registry
3. dApp Adds Wallet Service to init options

FCL tells Discovery which services are supported by the client (installed extensions, ServicePlugins, WalletConnect, extension) so only those supported will be shown in Discovery UI or returned via Discovery API.

## Wallet Provider Spec
- Link to Wallet Provider Spec


---
## Browser and Mobile Support

- Deep Link Format
- FCL will attempt to open the following
- `let url = yourWebsiteURL + "?uri=" + queryString`

**Mobile Flow**

- User presses button to connect and is redirected to wallet of choice
- Wallet prompts user to approve or reject session
- Wallet prompts user to return to dApp manually
- User presses back/return button to return to dApp
- Similar pattern happens when signing requests are required from the user:
- Dapp redirects user automatically to previously chosen wallet
- Wallet prompts user to approve or reject request
- Wallet prompts user to return to dApp manually
- User presses back/return button to return to dApp

# fcl-wc

The package exports `init` and ??? getSdkError util.

Currently, a WalletConnect projectId is required and can be obtained @ <https://cloud.walletconnect.com>. Metadata is optional.

Initialization returns `FclWcServicePlugin` and `client`. The client can be used to subscribe to events, disconnect, and query session and pairing status.

Passing `FclWcServicePlugin` to fcl.pluginRegistry.add() will enable "WC/RPC" service strategy method and add WalletConnect wallet services to FCL Discovery UI/API.

dApps using FCL Discovery benefit from automatic support for Flow wallets listed with the WalletConnect Cloud Registry. These will be shown on the Discovery UI during authentication, and returned with service data from Discovery API.
Wallets not included in the WC Registry or FCL Discovery Repo can be added on initialization.

### opts

- `projectId` (required)
- `metadata`
- `includeBaseWC` (default: false): If true, will include a generic WalletConnect service
- `wcRequestHook` (default: null): A function to be called on a Desktop session request so the dApp can inform the user to open and approve in the user's mobile wallet. This will be called if a wallet was previously connected and no QR code scanning is required to pair.
- `wallets` (default: []): **testnet only** The dApp can include an array of wallet services of type `authn`. These will be combined with wallets returned from [WalletConnect cloud registry API](https://cloud.walletconnect.com/), deduped by Service uid and sent to Discovery for display in UI and inclusion in API response.

:exclamation: Setting `fcl.config.network` to **testnet** or **mainnet** is required to use `fcl-wc`
as it enable "WC/RPC" service strategy to request correct chain permissions.

import {config} from '@onflow/config'

config({
    flow.network: 'testnet'
})
import * as fcl from '@onflow/fcl'
import { init } from '@onflow/fcl-wc'

const { FclWcServicePlugin, client } = await init({
  projectId: PROJECT_ID,
  metadata: {
    name: 'Killer dApp',
    description: 'Flow dApp with support for WalletConnect',
    url: 'https://flow.com/',
    icons: ['https://avatars.githubusercontent.com/u/62387156?s=280&v=4']
  },
  sessionRequestHook: () => {},
  wallets: []
})

fcl.pluginRegistry.add(FclWcServicePlugin)

**Using the client**
import { getSdkError } from '@onflow/fcl-wc'

client.on('session_update', ({ topic, params }) => {
  const session = client.session.get(topic)
  console.log('EVENT', 'session_update', { topic, params, session })
})

await client.disconnect({
  topic: session.topic,
  reason: getSdkError('USER_DISCONNECTED')
})

# Wallet Support for FCL x WalletConnect

## Wallet Provider Spec

- Obtain a WC projectID
- Register with WalletConnect Cloud Registry (optional)
- Conform to FCL Spec
  - chains
  - methods
    - `flow_authn`
      - AuthnResponse
        - used to create FCL currentUser
        - account
        - services
      - optional* [account-proof](https://github.com/onflow/fcl-js/blob/master/docs/reference/proving-authentication.mdx)
    - `flow_authz`
    - `flow_user_sign`

```javascript

import SignClient from '@walletconnect/sign-client'

export let signClient: SignClient

export async function createSignClient() {
  signClient = await SignClient.init({
    projectId: process.env.NEXT_PUBLIC_PROJECT_ID,
    relayUrl: process.env.NEXT_PUBLIC_RELAY_URL ?? 'wss://relay.walletconnect.com',
    metadata: {
      name: 'React Wallet',
      description: 'React Wallet for WalletConnect',
      url: 'https://walletconnect.com/',
      icons: ['https://avatars.githubusercontent.com/u/37784886']
    }
  })
}

````

:exclamation: In order to correctly identify, improve pairing, and include deep link support for mobile, services using the WC/RPC method need to use the same universal link as their `uid` and `url` in Wallet metadata.

### Next steps

1. Learn about most common use cases and how to implement them.
2. Check out [WalletConnect examples and resources](https://docs.walletconnect.com/2.0/introduction/examples-and-resources) and build a wallet.

- Link to React Wallet
- Link to Lilico Wallet
