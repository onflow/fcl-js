# Add FCL Support for WalletConnect 2.0

To improve developer experience and streamline Flow dApp integration with **WalletConnect 2.0** wallets, **FCL `^1.3.0`** introduces support for **`discovery-service`** plugins. These **`ServicePlugins`** allow for injection of client configured **services**, service **methods**, and the execution **strategies** required to interact with them.
FCL dApps can opt-in through use of the [**fcl-wc**](https://www.npmjs.com/package/@onflow/fcl-wc) package and **FCL Plugin Registry**.

When using FCL Discovery for authentication, dApps are able to support most FCL-compatible wallets and their users on Flow without any custom integrations or changes needed to the dApp code. These instructions explain how dApps can also add support for FCL compatible wallets that use the WalletConnect 2.0 protocol.

## How does it work?

- The **`fc-wc`** package is used to initialize a **WalletConnect 2.0** **`SignClient`** instance, and build a **`discovery-service`** **`ServicePlugin`** based on dApp specified options.
- **`discovery-service`** plugins are used to add opt-in wallets and other services to **FCL Wallet Discovery** (UI/API).
- The **FCL Plugin Registry** offers dApps the ability to add new services, methods, and the execution strategies needed to interact with them.

### Requirements

- `fcl` version >= `1.3.0`
- `fcl-wc` version >= `1.0.0`

### Implementation path

|     |    |    |
| :-: | :- | :- |
| [**1**](#1-add-required-packages) | Add required packages | Install and import minimum `fcl` and `fcl-wc` [versions](#requirements)|
| [**2**](#2-obtain-a-walletconnect-projectid) | Obtain a WalletConnect `projectID` | Visit [WalletConnect Cloud Registry](https://cloud.walletconnect.com/) and register for public relay server access and an application `projectId` |
| [**3**](#3-initialize-walletconnect-signclient-and-fclwcserviceplugin) | Initialize WalletConnect `SignClient` and `FclWcServicePlugin` | Initialize WalletConnect `SignClient` and `FclWcServicePlugin` with [configuration options](#configuration-options) |
| [**4**](#4-add-fclwcserviceplugin-to-fcl-plugin-registry) | Add `FclWcServicePlugin` to FCL Plugin Registry | Inject `FclWcServicePlugin` via `fcl.pluginRegistry.add(FclWcServicePlugin)` |

### 1. Add required packages

Install the `fcl` and `fcl-wc` packages:

```bash
npm install @onflow/fcl@ @onflow/fcl-wc
```

#### Note

:exclamation: FCL needs to be configured with a specified network. 
`fcl.config({"flow.network": "mainnet"})`

See [FCL Configuration](https://developers.flow.com/tools/fcl-js/reference/configure-fcl) for more information.

### 2. Obtain a WalletConnect projectID

Visit [WalletConnect Cloud Registry](https://cloud.walletconnect.com/) and register for public relay server access and an application **`projectId`**.

### 3. Initialize WalletConnect `SignClient` and `FclWcServicePlugin`

In addition to the WalletConnect `SignClient`, the `init` method of `fcl-wc` returns a `ServicePlugin` object. This object can be injected using the FCL Plugin Registry to add support for new service methods and their corresponding execution strategies (like `WC/RPC` for WalletConnect ).
A `discovery-service` `ServicePlugin` may also include additional opt-in wallets to offer your users through FCL Wallet Discovery.

#### Configuration options

:exclamation: Setting `fcl.config.network` to **testnet** or **mainnet** is required to use `fcl-wc`
as it enable `"WC/RPC"` service strategy to request correct chain permissions.

Initialize WalletConnect `SignClient` and `FclWcServicePlugin` with the following configuration options:

| Name       | Type    | Default | Description                                                                    |
| ---------- | ------- | ------- | ------------------------------------------------------------------------------ |
| `projectId` | boolean **(required)** | null   | A WalletConnect projectId for public relay server access. Your Project ID can be obtained from [WalletConnect Cloud Dashboard](https://cloud.walletconnect.com/app)  |
| `metadata` | object | { }  | Optional dApp metadata to describe your application and define its appearance in a web browser. More details can be found [here](https://docs.walletconnect.com/2.0/swift/sign/dapp-usage) |
| `includeBaseWC` | boolean | false   | Optional configuration to include a generic WalletConnect service in FCL Discovery (UI/API). <br /> :exclamation: BaseWC Service offers no deeplink support for mobile. |
| `wcRequestHook` | function | null  | Optional function is called on all desktop WalletConnect client session proposals and signing requests. Use this to handle alerting user to check wallet for approval. |
| `pairingModalOverride` | function | null  | Optional function is called to allow override of included QRCodeModal. Function receives two arguments: 1. Connection `uri` to display QR code or send to wallet, and callback function to manually cancel the request. |
| `wallets` | array | [ ] | Optional list of WalletConnect `authn` services to include in Discovery UI/API. <br /> :exclamation: Only available for use on **`testnet`**. These will be combined with wallets returned from [WalletConnect cloud registry API](https://cloud.walletconnect.com/), deduped by `service.uid`, and sent to Discovery for display in UI and inclusion in API response. |

#### Returns

|  Name  |  Type  |  Description  |
| ----- | ------- | ---------- |
| [FclWcServicePlugin](#fclwcserviceplugin) | `ServicePlugin` | A ServicePlugin of type `discovery-service`.  May also include optional `authn` services to offer through FCL Wallet Discovery (UI/API). |
| [client](#) | `SignClient` | An initialized WalletConnect `SignClient` |

### 4. Add FclWcServicePlugin to FCL Plugin Registry

When using FCL Discovery for authentication, dApps are able to support FCL-compatible wallets on Flow without any custom integrations or changes needed to the dApp code.

These instructions explain how dApps can also add support for FCL compatible wallets that use the WalletConnect 2.0 protocol.

Once a valid `FclWcServicePlugin` is registered, FCL shares client supported services with Discovery which adds registered and injected wallets to the UI and API. To connect a Flow supported wallet using WalletConnect 2.0, users of your dApp will go through the authentication process and have the option to select their preferred wallet.

FCL will handle client connections and pairing during FCL `authn`, and initiate WalletConnect signing requests as part of `authz`/`mutate` or [`user signing`](https://github.com/onflow/fcl-js/blob/master/docs/reference/user-signatures.mdx).

#### Usage

```js
import * as fcl from "@onflow/fcl"
import { init } from "fcl-wc"

const { FclWcServicePlugin, client } = await init({
  projectId: WC_PROJECT_ID, // required
  metadata: WC_APP_METADATA, // optional
  includeBaseWC: false, // optional, default: false
  wallets: [], // optional, default: []
  wcRequestHook: (wcRequestData) => { // optional,default: null
    handlePendingRequest(data)
  },
  pairingModalOverride: (uri, rejectPairingRequest) => { // optional,default: null
    handlePendingPairingRequest(data)
  }
})

fcl.pluginRegistry.add(FclWcServicePlugin)
```
---

### FclWcServicePlugin

In addition to the WalletConnect `SignClient`, the `init` method of `fcl-wc` returns a `ServicePlugin` object. This object can be injected into the FCL Plugin Registry to add FCL support for new service methods, like (WC/RPC) for WalletConnect and corresponding execution strategies.
A `ServicePlugin` may also include optional services to offer through FCL Wallet Discovery.

A subtype of FCL [ServicePlugin](#serviceplugin-spec).

### ServicePlugin Spec

| Key         | Value Type | Description                   |
| ----------- | ---------- | ----------------------------- |
| `name`        | string     | The id of the block.          |
| `f_type`  | string     | The type of plugin |
| `type`    | string     | The plugin subtype |
| `services` | array     | An list of services to add to FCL |
| `serviceStrategy` | {method: string, exec: function }     | The method and corresponding strategy FCL uses to interact with the service. A service with the `service.method` property set to `"WC/RPC"` tells FCL to use the corresponding service strategy if it is supported by the dApp. |

#### Example

```js
const FclWcServicePlugin = ({
  name: "fcl-plugin-service-walletconnect",
  f_type: "ServicePlugin",
  type: "discovery-service",
  services: [Service],
  serviceStrategy: {method: "WC/RPC", exec: execStrategy,
})
```

---

## Integrating With Wallet Discovery

Knowing all the wallets available to users on a blockchain can be challenging. FCL's Discovery mechanism relieves much of the burden of integrating with Flow compatible wallets and let's developers focus on building their dApp and providing as many options as possible to their users.

There are two ways an app can use Discovery:

1. The UI version which can be configured for display via iFrame, Popup, or Tab.

2. The API version which allows you to access authentication services directly in your code via fcl.discovery.authn method which we'll describe below.](<https://github.com/onflow/fcl-js/blob/master/docs/reference/discovery.mdx>)

![Wallet Discovery UI](../images/discovery.png)

### How to add your flow enabled wc wallet to Discovery (UI/API)

1. Add to Discovery services.json PR
2. Add to WC Wallet Registry
3. dApp Adds Wallet Service to init options

FCL tells Discovery which services are supported by the client (installed extensions, ServicePlugins, WalletConnect, extension) so only those supported will be shown in Discovery UI or returned via Discovery API.

## Wallet Provider Spec
- Link to Wallet Provider Spec


---
## Browser and Mobile Support

- Deep Link Format
- FCL will attempt to open the following
- `let url = yourWebsiteURL + "?uri=" + queryString`

**Mobile Flow**

- User presses button to connect and is redirected to wallet of choice
- Wallet prompts user to approve or reject session
- Wallet prompts user to return to dApp manually
- User presses back/return button to return to dApp
- Similar pattern happens when signing requests are required from the user:
- Dapp redirects user automatically to previously chosen wallet
- Wallet prompts user to approve or reject request
- Wallet prompts user to return to dApp manually
- User presses back/return button to return to dApp

### opts

dApps using FCL Discovery benefit from automatic support for Flow wallets listed with the WalletConnect Cloud Registry. These will be shown on the Discovery UI during authentication, and returned with service data from Discovery API.
Wallets not included in the WC Registry or FCL Discovery Repo can be added on initialization.

import {config} from '@onflow/config'

config({
    flow.network: 'testnet'
})

import * as fcl from '@onflow/fcl'
import { init } from '@onflow/fcl-wc'

const { FclWcServicePlugin, client } = await init({
  projectId: PROJECT_ID,
  metadata: {
    name: 'Killer dApp',
    description: 'Flow dApp with support for WalletConnect',
    url: 'https://flow.com/',
    icons: ['https://avatars.githubusercontent.com/u/62387156?s=280&v=4']
  },
  sessionRequestHook: () => {},
  wallets: []
})

fcl.pluginRegistry.add(FclWcServicePlugin)

**Using the client**
import { getSdkError } from '@onflow/fcl-wc'

client.on('session_update', ({ topic, params }) => {
  const session = client.session.get(topic)
  console.log('EVENT', 'session_update', { topic, params, session })
})

await client.disconnect({
  topic: session.topic,
  reason: getSdkError('USER_DISCONNECTED')
})

# Wallet Support for FCL x WalletConnect

## Wallet Provider Spec

- Obtain a WC projectID
- Register with WalletConnect Cloud Registry (optional)
- Conform to FCL Spec
  - chains
  - methods
    - `flow_authn`
      - AuthnResponse
        - used to create FCL currentUser
        - account
        - services
      - optional* [account-proof](https://github.com/onflow/fcl-js/blob/master/docs/reference/proving-authentication.mdx)
    - `flow_authz`
    - `flow_user_sign`

```javascript

import SignClient from '@walletconnect/sign-client'

export let signClient: SignClient

export async function createSignClient() {
  signClient = await SignClient.init({
    projectId: process.env.NEXT_PUBLIC_PROJECT_ID,
    relayUrl: process.env.NEXT_PUBLIC_RELAY_URL ?? 'wss://relay.walletconnect.com',
    metadata: {
      name: 'React Wallet',
      description: 'React Wallet for WalletConnect',
      url: 'https://walletconnect.com/',
      icons: ['https://avatars.githubusercontent.com/u/37784886']
    }
  })
}

````

:exclamation: In order to correctly identify, improve pairing, and include deep link support for mobile, services using the WC/RPC method need to use the same universal link as their `uid` and `url` in Wallet metadata.

### Next steps

1. Learn about most common use cases and how to implement them.
2. Check out [WalletConnect examples and resources](https://docs.walletconnect.com/2.0/introduction/examples-and-resources) and build a wallet.

- Link to React Wallet
- Link to Lilico Wallet
